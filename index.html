<html>
  <body>

    <div>
      <div class="js-fileapi-wrapper upload-btn">
        <div class="upload-btn__txt">Choose images</div>
        <br>
        <input id="choose" name="files" type="file" multiple />
      </div>
    </div>

    <div id="imageResizeControlsContainer">
      <div>
        <p>Area width: <input type="text" id="areaWidthInput" value="700"></p>
        <p>Area height: <input type="text" id="areaHeightInput" value="800"></p>
        <p><input id="start" type="button" value="Resize images"></p>
      </div>
    </div>

    <div id="visualization" style="background-color: #778899;"></div>

    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>window.FileAPI = { staticPath: 'js/FileAPI/' };</script>
    <script src="js/FileAPI/FileAPI.js"></script>
    <script>
    $(document).ready(function() {

      //Init
      var viz = $('#visualization');
      var imageResizeControlsContainer = $('#imageResizeControlsContainer');
      var minHeight = 100;

      function init() {
        initFileInputListener();

        $('#start').click(function() {
          var vizWidth = $('#areaWidthInput').val();
          var vizHeight = $('#areaHeightInput').val();
          viz.width(vizWidth).height(vizHeight);
          viz.show();

          calculateAll();
        });

        imageResizeControlsContainer.hide();
        viz.hide();
      }

      //http://stackoverflow.com/questions/1186414/whats-the-algorithm-to-calculate-aspect-ratio-i-need-an-output-like-43-169
      //Greatest common divisor (GCD)
      function gcd (a, b) {
        return (b == 0) ? a : gcd (b, a%b);
      }

      //http://stackoverflow.com/questions/1682495/jquery-resize-to-aspect-ratio
      function getNewWidthInAspectRatio(newHeight, currentWidth, currentHeight){
        var aspectRatio = currentWidth / currentHeight;
        return newHeight * aspectRatio;
      }

      function getImageAspectRatio($img) {
        var r = gcd($img.width(), $img.height());
        return $img.width()/r + ":" + $img.height()/r;
      }

      function calculateRowHeight(images) {
        var imgAspectCombined = 0;

        for(var i=0; i<images.length; i++) {
          var img = $( images[i] );
          imgAspectCombined += (img.width()/img.height());
        };

        var imgNewHeight = viz.width() / imgAspectCombined;

        return imgNewHeight;
      }

      function calculateRow(images) {
        var imgNewHeight = calculateRowHeight(images);

        for(var i=0; i<images.length; i++) {
          var img = $( images[i] );
          var imgNewWidth = getNewWidthInAspectRatio(imgNewHeight, img.width(), img.height());
          img.height(imgNewHeight).width(imgNewWidth);
        };
      }

      function calculateAll() {
        var allImages = viz.find('canvas');
        var imgNewHeight = calculateRowHeight(allImages);
        var rows = 1;
        var splittedArrays = [allImages];

        while(imgNewHeight < minHeight) {
          rows++;
          splittedArrays = splitArray(allImages, rows);
          imgNewHeight = calculateRowHeight(splittedArrays[0]);
        }
        
        for(var i=0; i<splittedArrays.length; i++) {
          calculateRow(splittedArrays[i]);
        } 
      }

      function splitArray(array, chunks) {
        var chunkSize = parseInt(array.length / chunks);
        var resultArrays = [];
        var resultArray = [];

        for(var i=0; i<array.length; i++) {
          resultArray.push(array[i]);

          if(resultArray.length >= chunkSize) {
            resultArrays.push(resultArray);
            resultArray = [];
          }
        }

        return resultArrays;
      }

      function initFileInputListener() {
        var el = document.getElementById('choose');
        FileAPI.event.on(el, 'change', function (evt){
          var files = FileAPI.getFiles(evt);

          FileAPI.each(files, function(file) {
            FileAPI.getInfo(file, function (err/**String*/, info/**Object*/){
              if( !err ){
                imageUploaded(file, info.width, info.height);
              }
            });
          });

          imageResizeControlsContainer.show();
        });
      }

      function imageUploaded(file, width, height) {
        var previewImageSize = scaleSize(300, 300, width, height);
        addPreviewImage(file, previewImageSize.width, previewImageSize.height);
      }

      function addPreviewImage(file, width, height) {
        FileAPI.Image(file)/*.resize(width, height)*/.get(function (err/**String*/, img/**HTMLElement*/){
          if( !err ){
            var $img = $(img).width(width).height(height);
            viz.append($img);
            //document.body.appendChild( img );
          }
        });
      }

      //http://www.ajaxblender.com/howto-resize-image-proportionally-using-javascript.html
      function scaleSize(maxW, maxH, currW, currH){

        var ratio = currH / currW;
        
        if(currW >= maxW && ratio <= 1){
          currW = maxW;
          currH = currW * ratio;
        } else if(currH >= maxH){
          currH = maxH;
          currW = currH / ratio;
        }

        return {
          width: currW, 
          height: currH}
        ;
      }

      

      init();
      
    });
    </script>
  </body>
</html>